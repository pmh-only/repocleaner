<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Repo Cleaner</title>
  </head>
  <body>
    <header style="font-size: 20px; background-color: aqua; padding: 20px; border: double 10px gray; display: inline-block; margin-bottom: 20px;">
      <h2># <a href="https://github.com/pmh-only">pmh-only</a>/RepoCleaner</h2>
      <p>Repo Cleaner for Github</p>
      <p>Notice:</p>
      <ul>
        <li>this service uses <a href="https://pages.github.com/">github static hosting</a>, <a href="https://workers.cloudflare.com/">cloudflare workers</a>.</li>
        <li>We do not collect any data of your account</li>
      </ul>
      <a href="./docs/demo.gif">demo gif image</a>
      <p>&copy; 2021. Park Min Hyeok &lt;pmhstudio.pmh@gmail.com&gt;.</p>
    </header>
    <article>
      <a id="login" href="https://github.com/login/oauth/authorize?client_id=2a58b27c5db4b250935b&scope=repo,delete_repo&allow_signup=false"><button>login with github account to continue</button></a>
      <div id="content" style="display: none;">
        <form onsubmit="return false" id="form">
          <label for="mindate">archive repositories that lastest pushed time was more than </label>
          <input type="number" value="30" min="0" id="mindate" style="max-width: 100px; text-align: right;">
          <label for="mindate">days ago</label>
          <div style="border: 2px solid gray; overflow-y: scroll; max-width: 500px; height: 500px;" id="archiverepos">
            <b>Fetching Repos...</b>
          </div>
          <input type="submit" value="Archive repos" id="archivebtn">
        </form>
      </div>
    </article>

    <footer>
      <pre id="console"></pre>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fetch-polyfill@0.8.2/fetch.min.js"></script>
    <script>
      (async function () {
        const formElem = document.getElementById('form')
        const loginElem = document.getElementById('login')
        const contentElem = document.getElementById('content')
        const consoleElem = document.getElementById('console')
        const mindateElem = document.getElementById('mindate')
        const archiveBtnElem = document.getElementById('archivebtn')
        const archiveReposElem = document.getElementById('archiverepos')

        consoleElem.innerText += '> console attached\n'

        const url = new URL(window.location.href)
        const code = url.searchParams.get('code')
        if (!code) return

        consoleElem.innerText += '> github oauth code found\n> request github oauth token. please wait...\n'

        window.history.replaceState({}, document.title, '/index.html')
        const token = await window.fetch('https://cors.pmhonly.workers.dev/?https://github.com/login/oauth/access_token?client_id=2a58b27c5db4b250935b&client_secret=e049f2d2f81cb81412459ecf6ad1a43c9d5969ec&code=' + code, { method: 'POST', headers: { Accept: 'application/json' } }).then((res) => res.json())
        if (token.error) {
          loginElem.style.display = 'block'
          contentElem.style.display = 'none'
          consoleElem.innerText += '> Error: invalid github oauth code\n'
          return
        }

        consoleElem.innerText += '> github oauth token granted\n'

        loginElem.style.display = 'none'
        contentElem.style.display = 'block'

        const repos = []
        for (let i = 1; true; i++) {
          consoleElem.innerText += `> request repo page #${i}\n`
          const repopage = await window.fetch('https://cors.pmhonly.workers.dev/?https://api.github.com/user/repos?per_page=100&sort=pushed&affiliation=owner&page=' + i, {
            headers: {
              Accept: 'application/vnd.github.v3+json',
              Authorization: 'token ' + token.access_token
            },
          }).then(function(res) {return res.json()})

          if (repopage.length < 1) break
          repos.push(...repopage)
        }

        consoleElem.innerText += `> done.\n`

        renderArchiveList()
        mindateElem.onchange = () => renderArchiveList()
        archiveReposElem.onchange = () => renderArchiveBtn()
        formElem.onsubmit = (event) => {
          event.preventDefault()

          let finished = 1
          const queue = []
          for (const repo of repos) {
            const elem = document.getElementById('archive_' + repo.full_name)
            if (!elem) continue
            if (!elem.checked) continue
            queue.push(repo.full_name)
          }

          if (!confirm(`Queue: Archive ${queue.length} repos\n\n!warning! this process is unstoppable, continue?`)) return
          for (const repoFullname of queue) {
            (async() => {
              consoleElem.innerText += `> archiving ${repoFullname}...\n`
              await window.fetch('https://cors.pmhonly.workers.dev/?https://api.github.com/repos/' + repoFullname, {
                method: 'PATCH',
                headers: {
                  Accept: 'application/vnd.github.v3+json',
                  Authorization: 'token ' + token.access_token,
                  'Content-Type': 'application/json'
                },
                body: "{\"archived\":true}"
              })
              consoleElem.innerText += `> archived ${repoFullname}!\n`
              finished++

              if (finished >= queue.length) alert('done!')
            })()
          }
        }

        function renderArchiveList () {
          archiveReposElem.innerHTML = ''
          for (const repo of repos) {
            const pushed_at = new Date(repo.pushed_at)
            const current = Date.now()
            if (Number(pushed_at) > current - 1000 * 24 * 60 * 60 * mindateElem.value || repo.archived) continue
            archiveReposElem.innerHTML += `<input type="checkbox" id="archive_${repo.full_name}" checked><label for="archive_${repo.full_name}">${repo.full_name}(D+${Math.floor((current - Number(pushed_at)) / 1000 / 24 / 60 / 60)})</label><br/>`
          }
          
          renderArchiveBtn()
        }

        function renderArchiveBtn () {
          let l = 0
          for (const repo of repos) {
            const elem = document.getElementById('archive_' + repo.full_name)
            if (!elem) continue
            if (!elem.checked) continue
            l++
          }
          archiveBtnElem.value = `Archive ${l} repos`
        }
      })()
    </script>
  </body>
</html>
